<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinterChat - Ana Merkez</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <style>
        /* Modern KaranlÄ±k Tema ve DÃ¼zen */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { height: 100vh; display: flex; background-color: #0F172A; color: #F8FAFC; overflow: hidden; }

        /* GÃœVENLÄ°K DUVARI */
        #auth-guard { position: fixed; top:0; left:0; width:100%; height:100%; background:#0F172A; z-index:9999; display:flex; justify-content:center; align-items:center; color:white; font-size:24px; }

        /* SOL MENÃœ (KiÅŸiler ve Arama) */
        .sidebar { width: 300px; background-color: #1E293B; display: flex; flex-direction: column; border-right: 1px solid #334155; z-index: 10; }
        .logo-area { padding: 20px; font-size: 22px; font-weight: 900; letter-spacing: 1px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;}
        .logo-area span { color: #38BDF8; }
        .logo-area.vip span { color: #F59E0B; text-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }

        /* Arama ve Ekleme AlanÄ± */
        .search-area { padding: 15px; border-bottom: 1px solid #334155; background: #0B0F19; }
        .search-box { display: flex; gap: 5px; }
        .search-box input { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #475569; background: #1E293B; color: white; outline: none; }
        .search-box button { padding: 10px 15px; border-radius: 6px; border: none; background: #22C55E; color: white; font-weight: bold; cursor: pointer; transition: 0.2s;}
        .search-box button:hover { background: #16A34A; }

        /* ArkadaÅŸlar Listesi */
        .friends-list { flex: 1; padding: 15px 10px; overflow-y: auto; }
        .section-title { font-size: 12px; color: #94A3B8; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; padding-left: 5px; }
        .friend-item { padding: 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; margin-bottom: 5px; background: rgba(255,255,255,0.02);}
        .friend-item:hover { background: rgba(255,255,255,0.05); }
        .friend-avatar { width: 35px; height: 35px; border-radius: 50%; background: #38BDF8; display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; }
        .friend-name { font-weight: bold; color: #E2E8F0; }

        /* Alt Profil AlanÄ± */
        .profile-area { padding: 15px; background-color: #0B0F19; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid #334155; }
        .user-name-display { font-size: 16px; font-weight: bold; color: white; text-transform: uppercase; }
        .vip-badge { display: none; background: #F59E0B; color: black; font-size: 10px; padding: 2px 5px; border-radius: 4px; font-weight: 900; }
        .my-id-box { background: #1E293B; padding: 8px; border-radius: 6px; text-align: center; font-weight: bold; color: #38BDF8; border: 1px dashed #475569; cursor: pointer; font-size: 14px;}
        .logout-btn { background: #EF4444; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* ANA SOHBET ALANI */
        .main-content { flex: 1; display: flex; flex-direction: column; background: #0F172A; }
        
        /* BaÄŸlantÄ± Ã‡ubuÄŸu (P2P) */
        .connect-bar { padding: 15px 20px; background: #1E293B; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #334155; }
        .connect-info { color: #94A3B8; font-size: 14px; margin-right: auto; }
        .connect-bar input { width: 200px; padding: 10px; border-radius: 6px; border: 1px solid #475569; background: #0F172A; color: white; outline: none; }
        .connect-bar button { padding: 10px 20px; border-radius: 6px; border: none; background: #38BDF8; color: white; font-weight: bold; cursor: pointer; }
        
        /* MesajlaÅŸma EkranÄ± */
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 65%; padding: 12px 16px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative;}
        .msg.me { align-self: flex-end; background: #38BDF8; border-bottom-right-radius: 2px; }
        .msg.me.vip-msg { background: linear-gradient(45deg, #F59E0B, #D97706); box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3); }
        .msg.other { align-self: flex-start; background: #334155; border-bottom-left-radius: 2px; }
        .msg-sender { font-size: 11px; opacity: 0.7; display: block; margin-bottom: 5px; font-weight: bold; }

        /* Mesaj GÃ¶nderme Kutusu */
        .input-area { padding: 20px; background: #1E293B; display: flex; gap: 10px; border-top: 1px solid #334155;}
        .input-area input { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #475569; background: #0F172A; color: white; outline: none; font-size: 15px;}
        .input-area button { padding: 0 30px; border-radius: 10px; border: none; background: #38BDF8; color: white; font-weight: bold; cursor:pointer; transition: 0.2s;}
        .input-area button:hover { background: #0284C7; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="auth-guard">Kimlik doÄŸrulanÄ±yor...</div>

    <div class="sidebar">
        <div class="logo-area" id="logo">
            <div>â„ï¸ Winter<span>Chat</span></div>
        </div>

        <div class="search-area">
            <div class="section-title">KullanÄ±cÄ± Ara & Ekle</div>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="KullanÄ±cÄ± adÄ± yaz...">
                <button onclick="arkadasEkle()">Ekle</button>
            </div>
        </div>
        
        <div class="friends-list" id="friends-list-container">
            <div class="section-title">ArkadaÅŸlarÄ±m</div>
            </div>

        <div class="profile-area">
            <div>
                <span class="user-name-display" id="display-username">YÃ¼kleniyor...</span>
                <span class="vip-badge" id="myVipBadge">VIP</span>
            </div>
            <div style="font-size: 12px; color: #94A3B8; margin-top:5px;">Senin BaÄŸlantÄ± Kodun (TÄ±kla):</div>
            <div class="my-id-box" id="my-id" onclick="copyId()">YÃ¼kleniyor...</div>
            <button class="logout-btn" onclick="cikisYap()">Sistemden Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
    </div>

    <div class="main-content">
        
        <div class="connect-bar">
            <div class="connect-info" id="conn-status">ğŸ”´ Åu an kimseye baÄŸlÄ± deÄŸilsin.</div>
            <input type="text" id="friend-id-input" placeholder="WNT-XXXX (Kod Gir)">
            <button onclick="connectToFriend()">BaÄŸlan</button>
        </div>
        
        <div class="chat-area" id="chat-box">
            <div class="msg other" style="align-self: center; background: transparent; color: #64748B;">
                MesajlaÅŸmaya baÅŸlamak iÃ§in arkadaÅŸÄ±nÄ±n anlÄ±k baÄŸlantÄ± kodunu (WNT-XXXX) girmelisin.
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="MesajÄ±nÄ± buraya yaz..." onkeypress="handleEnter(event)" disabled>
            <button id="send-btn" onclick="sendMessage()" disabled>GÃ¶nder</button>
        </div>
    </div>

    <script>
        // --- 1. SÄ°STEM GÃœVENLÄ°ÄÄ° VE VERÄ°TABANI ---
        let activeUser = localStorage.getItem('activeUser');
        let isVIP = false;
        let db = JSON.parse(localStorage.getItem('winterDB')) || {};

        function guvenlikKontrolu() {
            if(!activeUser) { window.location.href = "login.html"; return; }

            if(activeUser === "tutus" && localStorage.getItem('isAdmin') === 'true') {
                isVIP = true; 
            } else {
                let accountInfo = db[activeUser];
                if(!accountInfo || accountInfo.isBanned) { cikisYap(); return; }
                isVIP = accountInfo.isVip;
            }
            sistemiBaslat();
        }

        function sistemiBaslat() {
            document.getElementById('auth-guard').style.display = 'none';
            document.getElementById('display-username').innerText = activeUser;

            if(isVIP) {
                document.getElementById('myVipBadge').style.display = 'inline-block'; 
                document.getElementById('logo').classList.add('vip'); 
            }
            arkadasListesiniCiz(); // Sistemi baÅŸlatÄ±rken arkadaÅŸlarÄ± yÃ¼kle
        }

        function cikisYap() {
            localStorage.removeItem('activeUser');
            localStorage.removeItem('isAdmin');
            window.location.href = "login.html";
        }

        guvenlikKontrolu();

        // --- 2. ARKADAÅ EKLEME VE LÄ°STELEME SÄ°STEMÄ° ---
        function arkadasEkle() {
            const hedefKullanici = document.getElementById('search-input').value.trim();
            
            if(!hedefKullanici) return alert("LÃ¼tfen bir kullanÄ±cÄ± adÄ± girin!");
            if(hedefKullanici === activeUser) return alert("Kendinizi ekleyemezsiniz!");
            if(!db[hedefKullanici] && hedefKullanici !== 'tutus') return alert("Sistemde bÃ¶yle bir kullanÄ±cÄ± bulunamadÄ±!");

            // KullanÄ±cÄ±nÄ±n arkadaÅŸ listesini al (Yoksa boÅŸ dizi oluÅŸtur)
            if(!db[activeUser].friends) db[activeUser].friends = [];

            // Zaten ekli mi kontrol et
            if(db[activeUser].friends.includes(hedefKullanici)) {
                return alert("Bu kullanÄ±cÄ± zaten arkadaÅŸ listenizde!");
            }

            // Listeye ekle ve veritabanÄ±nÄ± kaydet
            db[activeUser].friends.push(hedefKullanici);
            localStorage.setItem('winterDB', JSON.stringify(db));
            
            document.getElementById('search-input').value = ""; // Kutuyu temizle
            alert(`${hedefKullanici} baÅŸarÄ±yla eklendi!`);
            arkadasListesiniCiz(); // Listeyi yenile
        }

        function arkadasListesiniCiz() {
            const container = document.getElementById('friends-list-container');
            // BaÅŸlÄ±ÄŸÄ± sabit tut, listeyi temizle
            container.innerHTML = '<div class="section-title">ArkadaÅŸlarÄ±m</div>';
            
            let myFriends = db[activeUser].friends || [];
            
            if(myFriends.length === 0) {
                container.innerHTML += `<div style="color: #64748B; font-size: 13px; text-align: center; margin-top: 20px;">HenÃ¼z arkadaÅŸÄ±n yok. YukarÄ±dan ekleyebilirsin.</div>`;
                return;
            }

            myFriends.forEach(friend => {
                let isFriendVip = db[friend] && db[friend].isVip;
                // Avatar iÃ§in ismin ilk harfini al
                let basHarf = friend.charAt(0).toUpperCase();
                
                let item = document.createElement('div');
                item.className = 'friend-item';
                item.innerHTML = `
                    <div class="friend-avatar">${basHarf}</div>
                    <div class="friend-name">
                        ${friend} ${isFriendVip ? '<span style="font-size:10px;">ğŸ’</span>' : ''}
                    </div>
                `;
                // ArkadaÅŸa tÄ±klayÄ±nca ismini kopyalama veya chat kutusuna alma Ã¶zelliÄŸi eklenebilir
                item.onclick = () => alert(`${friend} ile konuÅŸmak iÃ§in ondan gÃ¼ncel WNT-XXXX kodunu istemelisin.`);
                container.appendChild(item);
            });
        }

        // --- 3. P2P AÄ BAÄLANTISI (PEERJS) ---
        const myShortCode = 'WNT-' + Math.floor(1000 + Math.random() * 9000);
        const peer = new Peer(myShortCode); 
        let currentConnection = null;

        peer.on('open', (id) => { document.getElementById('my-id').innerText = id; });

        function copyId() { navigator.clipboard.writeText(myShortCode); alert("Kod KopyalandÄ±! ArkadaÅŸÄ±na GÃ¶nder."); }

        peer.on('connection', (conn) => { currentConnection = conn; setupEvents(); });

        function connectToFriend() {
            const friendId = document.getElementById('friend-id-input').value.trim().toUpperCase();
            if (!friendId) return;
            currentConnection = peer.connect(friendId);
            setupEvents();
        }

        function setupEvents() {
            currentConnection.on('open', () => {
                document.getElementById('conn-status').innerHTML = `ğŸŸ¢ <b>${currentConnection.peer}</b> ile baÄŸlantÄ± kuruldu!`;
                document.getElementById('conn-status').style.color = "#22C55E";
                
                // Mesaj kutularÄ±nÄ± aktif et
                document.getElementById('msg-input').disabled = false;
                document.getElementById('send-btn').disabled = false;
                
                document.getElementById('chat-box').innerHTML = `<div class="msg other" style="align-self:center; color:#22C55E; background: rgba(34, 197, 94, 0.1);">Sohbet BaÅŸladÄ±!</div>`;
            });

            currentConnection.on('data', (data) => {
                if(data.type === 'chat') {
                    addMessage(data.sender, data.content, "other", data.isVip);
                }
            });
        }

        // --- 4. SOHBET GÃ–NDERME ---
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentConnection) return;

            currentConnection.send({ type: 'chat', content: text, isVip: isVIP, sender: activeUser });
            addMessage(activeUser, text, "me", isVIP);
            input.value = '';
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        function addMessage(sender, content, type, senderIsVip) {
            const box = document.getElementById('chat-box');
            let vipClass = senderIsVip ? 'vip-msg' : '';
            
            box.innerHTML += `
                <div class="msg ${type} ${vipClass}">
                    <span class="msg-sender">${sender} ${senderIsVip ? 'ğŸ’' : ''}</span>
                    ${content}
                </div>`;
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
