<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinterChat v2.0 - Pro Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <style>
        /* Modern Kƒ±≈ü Temasƒ± & Animasyonlar */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { 
            height: 100vh; display: flex; justify-content: center; align-items: center; 
            background: radial-gradient(circle at center, #1A365D 0%, #0B192C 100%); 
            color: #f1f5f9; overflow: hidden; position: relative;
        }

        /* Kar Efekti */
        #snow-container { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.6; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }

        /* Ana √áer√ßeve */
        .app-container {
            width: 1050px; height: 650px; z-index: 10;
            background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex; overflow: hidden;
        }

        /* Sol Panel - Kontroller */
        .sidebar {
            width: 320px; background: rgba(0, 0, 0, 0.3); padding: 25px;
            display: flex; flex-direction: column; gap: 20px; border-right: 1px solid rgba(255,255,255,0.05);
        }
        .logo { font-size: 28px; font-weight: 800; text-align: center; color: #E0F2FE; letter-spacing: 1px; }
        .logo span { color: #38BDF8; }
        
        .box { background: rgba(255,255,255,0.05); padding: 18px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .box h3 { font-size: 13px; color: #94A3B8; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .my-id { font-size: 22px; font-weight: bold; background: rgba(0,0,0,0.4); padding: 12px; border-radius: 10px; text-align: center; letter-spacing: 3px; color: #38BDF8; cursor: pointer; transition: 0.2s;}
        .my-id:hover { background: rgba(0,0,0,0.6); }
        
        input { width: 100%; padding: 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: white; font-weight: bold; outline: none; margin-bottom: 12px; transition: 0.3s;}
        input:focus { border-color: #38BDF8; background: rgba(0,0,0,0.4); }
        
        button { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; font-size: 15px; cursor: pointer;
            background: #0284C7; color: white; transition: 0.2s;
        }
        button:hover { background: #0369A1; transform: translateY(-2px); }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-group button { font-size: 13px; padding: 10px; }
        .btn-green { background: #16A34A; } .btn-green:hover { background: #15803D; }
        .btn-purple { background: #7C3AED; } .btn-purple:hover { background: #6D28D9; }

        .video-container { display: flex; flex-direction: column; gap: 10px; margin-top: auto; position: relative;}
        video { width: 100%; border-radius: 12px; background: #000; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        #my-video { position: absolute; width: 30%; bottom: 10px; right: 10px; border: 2px solid rgba(255,255,255,0.2); }

        /* Saƒü Panel - ƒ∞√ßerik (Sohbet & Tahta) */
        .content-area { flex: 1; display: flex; flex-direction: column; background: rgba(15, 23, 42, 0.2); }
        
        /* Sekmeler */
        .tabs { display: flex; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tab { flex: 1; padding: 18px; text-align: center; font-weight: bold; cursor: pointer; color: #94A3B8; transition: 0.3s; }
        .tab:hover { color: white; background: rgba(255,255,255,0.02); }
        .tab.active { color: #38BDF8; border-bottom: 2px solid #38BDF8; background: rgba(56, 189, 248, 0.05); }

        /* Sohbet Ekranƒ± */
        #chat-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .messages { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; }
        
        .msg { max-width: 75%; padding: 14px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .msg.me { align-self: flex-end; background: #0284C7; border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: rgba(255,255,255,0.08); border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 8px; }
        .msg-time { font-size: 11px; opacity: 0.7; margin-top: 5px; text-align: right; }

        .input-area { padding: 20px 25px; background: rgba(0,0,0,0.3); display: flex; gap: 12px; align-items: center;}
        .file-label { background: rgba(255,255,255,0.05); padding: 14px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .file-label:hover { background: rgba(255,255,255,0.1); }
        #file-input { display: none; }

        /* Taktik Tahtasƒ± Ekranƒ± */
        #board-section { flex: 1; display: none; flex-direction: column; padding: 20px; }
        .board-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        canvas { flex: 1; background: rgba(0,0,0,0.4); border-radius: 12px; cursor: crosshair; border: 1px solid rgba(255,255,255,0.1); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="snow-container"></div>

    <div class="app-container">
        <div class="sidebar">
            <div class="logo">‚ùÑÔ∏è Winter<span>Chat</span></div>
            
            <div class="box">
                <h3>Senin Kodun (Tƒ±kla Kopyala)</h3>
                <div class="my-id" id="my-id" onclick="copyId()">Y√ºkleniyor...</div>
            </div>

            <div class="box">
                <h3>Baƒülantƒ± Kur</h3>
                <input type="text" id="friend-id-input" placeholder="Arkada≈üƒ±nƒ±n Kodunu Gir" autocomplete="off">
                <button onclick="connectToFriend()">Sohbete Baƒülan</button>
                <div class="btn-group">
                    <button class="btn-green" onclick="startVideoCall()">Kamera A√ß</button>
                    <button class="btn-purple" onclick="startScreenShare()">Ekran Payla≈ü</button>
                </div>
            </div>

            <div class="video-container">
                <video id="other-video" autoplay playsinline></video>
                <video id="my-video" autoplay playsinline muted></video>
            </div>
        </div>

        <div class="content-area">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chat')">üí¨ Sohbet</div>
                <div class="tab" onclick="switchTab('board')">üó∫Ô∏è Ortak Taktik Tahtasƒ±</div>
            </div>

            <div id="chat-section">
                <div class="messages" id="chat-box">
                    <div class="msg other" style="align-self: center; background: transparent; border: none; opacity: 0.5;">
                        Baƒülantƒ± bekleniyor...
                    </div>
                </div>
                <div class="input-area">
                    <label class="file-label" title="Resim/Dosya G√∂nder">
                        üìé <input type="file" id="file-input" onchange="sendFile(this)">
                    </label>
                    <input type="text" id="msg-input" placeholder="Mesaj g√∂nder..." onkeypress="handleEnter(event)">
                    <button style="width: 100px;" onclick="sendMessage()">G√∂nder</button>
                </div>
            </div>

            <div id="board-section">
                <div class="board-controls">
                    <div class="color-btn" style="background: #ef4444;" onclick="changeColor('#ef4444')"></div>
                    <div class="color-btn" style="background: #3b82f6;" onclick="changeColor('#3b82f6')"></div>
                    <div class="color-btn" style="background: #22c55e;" onclick="changeColor('#22c55e')"></div>
                    <div class="color-btn" style="background: #eab308;" onclick="changeColor('#eab308')"></div>
                    <div class="color-btn" style="background: #ffffff;" onclick="changeColor('#ffffff')"></div>
                    <button style="width: auto; padding: 5px 15px; margin-left: auto;" onclick="clearBoard()">Tahtayƒ± Temizle</button>
                </div>
                <canvas id="tactic-board"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- KAR EFEKTƒ∞ ---
        function createSnow() {
            const container = document.getElementById('snow-container');
            for(let i=0; i<60; i++) {
                let flake = document.createElement('div');
                flake.className = 'snowflake';
                let size = Math.random() * 4 + 2;
                flake.style.width = size + 'px'; flake.style.height = size + 'px';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = Math.random() * 3 + 3 + 's';
                flake.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        // --- SEKME DEƒûƒ∞≈ûTƒ∞RME ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('chat-section').style.display = tabName === 'chat' ? 'flex' : 'none';
            document.getElementById('board-section').style.display = tabName === 'board' ? 'flex' : 'none';
            if(tabName === 'board') resizeCanvas(); // Tahta a√ßƒ±lƒ±nca boyutunu ayarla
        }

        // --- P2P Aƒû BAƒûLANTISI ---
        const myShortCode = 'WNTR-' + Math.floor(1000 + Math.random() * 9000); // √ñrn: WNTR-4829
        const peer = new Peer(myShortCode); 
        let currentConnection = null;
        let myStream = null;

        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
        });

        function copyId() {
            navigator.clipboard.writeText(document.getElementById('my-id').innerText);
            alert("Arkada≈ülƒ±k kodun kopyalandƒ±!");
        }

        // --- BAƒûLANTI OLAYLARI ---
        peer.on('connection', (conn) => {
            currentConnection = conn;
            setupEvents();
        });

        function connectToFriend() {
            const friendId = document.getElementById('friend-id-input').value.trim().toUpperCase();
            if (!friendId) return;
            currentConnection = peer.connect(friendId);
            setupEvents();
        }

        function setupEvents() {
            currentConnection.on('open', () => {
                document.getElementById('chat-box').innerHTML = `<div class="msg other" style="align-self:center; background:#16A34A;">üü¢ Baƒülantƒ± Kuruldu!</div>`;
            });

            currentConnection.on('data', (data) => {
                if(data.type === 'chat') addMessage("Arkada≈ü", data.content, "other", data.time);
                else if(data.type === 'draw') drawOnCanvas(data.x, data.y, data.color, false);
                else if(data.type === 'startDraw') { ctx.beginPath(); ctx.moveTo(data.x, data.y); }
                else if(data.type === 'clearBoard') ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
        }

        // --- SOHBET Sƒ∞STEMƒ∞ ---
        function getTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentConnection) return;

            const time = getTime();
            currentConnection.send({ type: 'chat', content: text, time: time });
            addMessage("Sen", text, "me", time);
            input.value = '';
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        function sendFile(input) {
            const file = input.files[0];
            if(!file || !currentConnection) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                const content = file.type.startsWith('image/') ? `<img src="${dataUrl}">` : `üìÑ Dosya G√∂nderildi: ${file.name}`;
                const time = getTime();
                currentConnection.send({ type: 'chat', content: content, time: time });
                addMessage("Sen", content, "me", time);
            };
            reader.readAsDataURL(file);
        }

        function addMessage(sender, content, type, time) {
            const box = document.getElementById('chat-box');
            box.innerHTML += `
                <div class="msg ${type}">
                    <div>${content}</div>
                    <div class="msg-time">${time}</div>
                </div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- G√ñR√úNT√ú VE EKRAN PAYLA≈ûIMI ---
        peer.on('call', async (call) => {
            if(confirm("Gelen bir arama/ekran payla≈üƒ±mƒ± var, kabul ediyor musun?")) {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('my-video').srcObject = stream;
                call.answer(stream);
                call.on('stream', (otherStream) => {
                    document.getElementById('other-video').srcObject = otherStream;
                });
            }
        });

        async function startVideoCall() {
            if(!currentConnection) return alert("√ñnce baƒülanmalƒ±sƒ±n!");
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            makeCall(stream);
        }

        async function startScreenShare() {
            if(!currentConnection) return alert("√ñnce baƒülanmalƒ±sƒ±n!");
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            makeCall(stream);
        }

        function makeCall(stream) {
            document.getElementById('my-video').srcObject = stream;
            const call = peer.call(currentConnection.peer, stream);
            call.on('stream', (otherStream) => {
                document.getElementById('other-video').srcObject = otherStream;
            });
        }

        // --- ƒ∞NTERAKTƒ∞F TAKTƒ∞K TAHTASI (CANVAS) ---
        const canvas = document.getElementById('tactic-board');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let brushColor = '#ef4444';

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth - 40;
            canvas.height = canvas.parentElement.clientHeight - 80;
        }
        window.onresize = resizeCanvas;

        function changeColor(color) { brushColor = color; }

        function clearBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(currentConnection) currentConnection.send({ type: 'clearBoard' });
        }

        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (evt.clientX - rect.left) / (rect.right - rect.left) * canvas.width,
                y: (evt.clientY - rect.top) / (rect.bottom - rect.top) * canvas.height
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const pos = getMousePos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            if(currentConnection) currentConnection.send({ type: 'startDraw', x: pos.x, y: pos.y });
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const pos = getMousePos(e);
            drawOnCanvas(pos.x, pos.y, brushColor, true);
        });

        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);

        function drawOnCanvas(x, y, color, emit) {
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = color;
            ctx.lineTo(x, y);
            ctx.stroke();
            if (!emit || !currentConnection) return;
            currentConnection.send({ type: 'draw', x: x, y: y, color: color });
        }
    </script>
</body>
</html>
