<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinterChat - P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <style>
        /* KÄ±ÅŸ TemasÄ± ve Genel Ayarlar */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { 
            height: 100vh; display: flex; justify-content: center; align-items: center; 
            background: linear-gradient(135deg, #0B192C, #1A365D, #00A8E8); 
            color: white; overflow: hidden; position: relative;
        }

        /* Kar YaÄŸÄ±ÅŸÄ± Efekti Ä°Ã§in KapsayÄ±cÄ± */
        #snow-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.8; animation: fall linear infinite; }
        @keyframes fall {
            to { transform: translateY(100vh); }
        }

        /* ÅÄ±k Buzlu Cam (Glassmorphism) TasarÄ±mÄ± */
        .app-container {
            width: 900px; height: 600px; z-index: 10;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex; overflow: hidden;
        }

        /* Sol Panel - BaÄŸlantÄ± ve Kontroller */
        .sidebar {
            width: 300px; background: rgba(0, 0, 0, 0.2); padding: 20px;
            display: flex; flex-direction: column; gap: 20px; border-right: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 24px; font-weight: bold; text-align: center; color: #E0F2FE; text-shadow: 0 0 10px rgba(255,255,255,0.5); margin-bottom: 10px; }
        .logo span { color: #38BDF8; }
        
        .box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center;}
        .box h3 { font-size: 14px; color: #BAE6FD; margin-bottom: 8px; text-transform: uppercase; }
        .my-id { font-size: 18px; font-weight: bold; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; user-select: text; letter-spacing: 2px; }
        
        input { width: 100%; padding: 12px; border-radius: 8px; border: none; background: rgba(255,255,255,0.9); color: #0f172a; font-weight: bold; outline: none; margin-bottom: 10px; }
        button { 
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            background: linear-gradient(90deg, #0284C7, #0EA5E9); color: white; transition: 0.3s;
        }
        button:hover { background: linear-gradient(90deg, #0EA5E9, #38BDF8); box-shadow: 0 0 15px rgba(14, 165, 233, 0.5); }
        button.call-btn { background: linear-gradient(90deg, #16A34A, #22C55E); margin-top: 10px; }

        /* GÃ¶rÃ¼ntÃ¼lÃ¼ Arama VideolarÄ± */
        .video-container { display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
        video { width: 100%; border-radius: 10px; background: black; display: none; }

        /* SaÄŸ Panel - Sohbet AlanÄ± */
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: bold; color: #E0F2FE;}
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { max-width: 70%; padding: 12px 16px; border-radius: 15px; font-size: 15px; line-height: 1.4; word-wrap: break-word;}
        .msg.me { align-self: flex-end; background: #0284C7; border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: rgba(255,255,255,0.1); border-bottom-left-radius: 2px; border: 1px solid rgba(255,255,255,0.1); }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        .input-area { padding: 20px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; align-items: center;}
        .input-area input[type="text"] { flex: 1; margin: 0; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .input-area input[type="text"]::placeholder { color: #94A3B8; }
        .file-label { 
            background: rgba(255,255,255,0.1); padding: 12px 15px; border-radius: 8px; cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.2); font-size: 18px;
        }
        .file-label:hover { background: rgba(255,255,255,0.2); }
        #file-input { display: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div class="app-container">
        <div class="sidebar">
            <div class="logo">â„ï¸ Winter<span>Chat</span></div>
            
            <div class="box">
                <h3>Senin ArkadaÅŸlÄ±k Kodun</h3>
                <div class="my-id" id="my-id">YÃ¼kleniyor...</div>
            </div>

            <div class="box">
                <h3>ArkadaÅŸÄ±na BaÄŸlan</h3>
                <input type="text" id="friend-id-input" placeholder="ArkadaÅŸÄ±nÄ±n Kodunu Gir" autocomplete="off">
                <button onclick="connectToFriend()">Sohbete BaÄŸlan</button>
                <button class="call-btn" onclick="startVideoCall()">GÃ¶rÃ¼ntÃ¼lÃ¼ Ara</button>
            </div>

            <div class="video-container">
                <video id="other-video" autoplay playsinline></video>
                <video id="my-video" autoplay playsinline muted></video>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header" id="status-text">Durum: BaÄŸlantÄ± Bekleniyor...</div>
            
            <div class="messages" id="chat-box">
                <div class="msg other">Sisteme hoÅŸ geldin! Sol taraftaki kodunu arkadaÅŸÄ±na gÃ¶nder veya onun kodunu girerek baÄŸlan.</div>
            </div>

            <div class="input-area">
                <label class="file-label">
                    ğŸ“· <input type="file" id="file-input" accept="image/*" onchange="sendImage(this)">
                </label>
                <input type="text" id="msg-input" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." onkeypress="handleEnter(event)">
                <button style="width: auto; padding: 12px 25px;" onclick="sendMessage()">GÃ¶nder</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. KAR YAÄIÅI SÄ°STEMÄ° ---
        function createSnow() {
            const container = document.getElementById('snow-container');
            for(let i=0; i<50; i++) {
                let flake = document.createElement('div');
                flake.className = 'snowflake';
                let size = Math.random() * 5 + 2; // 2px - 7px arasÄ±
                flake.style.width = size + 'px';
                flake.style.height = size + 'px';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.animationDuration = Math.random() * 3 + 2 + 's'; // DÃ¼ÅŸme hÄ±zÄ±
                flake.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(flake);
            }
        }
        createSnow();

        // --- 2. P2P AÄ BAÄLANTISI (PEERJS) ---
        // Rastgele kÄ±sa bir kod Ã¼retir (Ã–rn: WNTR-A1B2)
        const myShortCode = 'WNTR-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        
        // PeerJS sunucusuna baÄŸlanÄ±yoruz
        const peer = new Peer(myShortCode); 
        let currentConnection = null;
        let myVideoStream = null;

        // Kodumuz hazÄ±r olduÄŸunda ekrana yazdÄ±r
        peer.on('open', (id) => {
            document.getElementById('my-id').innerText = id;
        });

        // --- 3. BÄ°RÄ° BÄ°ZE BAÄLANDIÄINDA ---
        peer.on('connection', (conn) => {
            currentConnection = conn;
            setupConnectionEvents();
        });

        // Biri bizi gÃ¶rÃ¼ntÃ¼lÃ¼ aradÄ±ÄŸÄ±nda
        peer.on('call', async (call) => {
            if(confirm("ArkadaÅŸÄ±n seni gÃ¶rÃ¼ntÃ¼lÃ¼ arÄ±yor, aÃ§mak ister misin?")) {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                showMyVideo(stream);
                call.answer(stream); // AramayÄ± cevapla ve kendi gÃ¶rÃ¼ntÃ¼nÃ¼ yolla
                
                call.on('stream', (otherStream) => {
                    showOtherVideo(otherStream);
                });
            }
        });

        // --- 4. BÄ°Z BÄ°RÄ°NE BAÄLANDIÄIMIZDA ---
        function connectToFriend() {
            const friendId = document.getElementById('friend-id-input').value.trim();
            if (!friendId) return alert("LÃ¼tfen geÃ§erli bir kod girin!");
            
            document.getElementById('status-text').innerText = "BaÄŸlanÄ±lÄ±yor...";
            currentConnection = peer.connect(friendId);
            setupConnectionEvents();
        }

        // BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa Ã§alÄ±ÅŸacak komutlar
        function setupConnectionEvents() {
            currentConnection.on('open', () => {
                document.getElementById('status-text').innerText = "ğŸŸ¢ BaÄŸlandÄ±: " + currentConnection.peer;
                addMessage("Sistem", "BaÄŸlantÄ± kuruldu! Sohbet edebilirsiniz.", "other");
            });

            // KarÅŸÄ±dan mesaj veya resim geldiÄŸinde
            currentConnection.on('data', (data) => {
                if(data.type === 'text') {
                    addMessage("ArkadaÅŸ", data.content, "other");
                } else if(data.type === 'image') {
                    addMessage("ArkadaÅŸ", `<img src="${data.content}">`, "other");
                }
            });
        }

        // --- 5. MESAJ VE RESÄ°M GÃ–NDERME ---
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !currentConnection) return;

            // KarÅŸÄ±ya gÃ¶nder
            currentConnection.send({ type: 'text', content: text });
            // Kendi ekranÄ±mÄ±za ekle
            addMessage("Sen", text, "me");
            input.value = '';
        }

        function handleEnter(e) {
            if(e.key === 'Enter') sendMessage();
        }

        function sendImage(input) {
            const file = input.files[0];
            if(!file || !currentConnection) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                // Resmi karÅŸÄ±ya gÃ¶nder
                currentConnection.send({ type: 'image', content: base64Image });
                // Kendi ekranÄ±mÄ±za ekle
                addMessage("Sen", `<img src="${base64Image}">`, "me");
            };
            reader.readAsDataURL(file); // Resmi koda Ã§evirip yollar (P2P iÃ§in ÅŸart)
        }

        // Ekrana baloncuÄŸu Ã§izen fonksiyon
        function addMessage(sender, content, type) {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="msg ${type}">${content}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- 6. GÃ–RÃœNTÃœLÃœ ARAMA BAÅLATMA ---
        async function startVideoCall() {
            if(!currentConnection) return alert("Ã–nce arkadaÅŸÄ±nÄ±zÄ±n koduna baÄŸlanmalÄ±sÄ±nÄ±z!");
            
            try {
                // Kamera ve mikrofon izni iste
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                showMyVideo(stream);
                
                const call = peer.call(currentConnection.peer, stream);
                
                call.on('stream', (otherStream) => {
                    showOtherVideo(otherStream);
                });
            } catch (err) {
                alert("Kamera/Mikrofon izni verilmedi veya cihaz bulunamadÄ±!");
            }
        }

        function showMyVideo(stream) {
            myVideoStream = stream;
            const video = document.getElementById('my-video');
            video.style.display = 'block';
            video.srcObject = stream;
        }

        function showOtherVideo(stream) {
            const video = document.getElementById('other-video');
            video.style.display = 'block';
            video.srcObject = stream;
        }
    </script>
</body>
</html>
